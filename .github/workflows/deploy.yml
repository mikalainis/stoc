name: Deploy to Cloud Run Jobs

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REPO_NAME: darwinian-repo
  IMAGE_NAME: darwinian-swarm
  # Define your schedule here for easy editing
  # 0: Minute 0
  # 10,14: At 10 AM and 2 PM (14:00)
  # *: Every day of month
  # *: Every month
    # 1-5: Monday (1) through Friday (5)
  CRON_SCHEDULE: "30 9,10,11,14,15 * * 1-5"
  REGION: us-east4

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Authenticate to Google Cloud
      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 2. Set up Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 3. Configure Docker
      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      # 4. Build and Push Docker Image
      - name: Build and Push
        run: |
          TAG="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}"
          docker build -t ${TAG}:${{ github.sha }} -t ${TAG}:latest .
          docker push ${TAG}:${{ github.sha }}
          docker push ${TAG}:latest

      # 5. Deploy Cloud Run Job
      - name: Deploy Cloud Run Job
        run: |
          gcloud run jobs deploy darwinian-swarm-job \
            --image ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest \
            --region ${{ secrets.GCP_REGION }} \
            --service-account ${{ secrets.GCP_SA_EMAIL }} \
            --set-env-vars GCS_BUCKET_NAME="darwinian-memory-${{ secrets.GCP_PROJECT_ID }}" \
            --set-env-vars SLACK_CHANNEL="D0A1C7TBB5E" \
            --set-secrets GOOGLE_API_KEY=GOOGLE_API_KEY:latest \
            --set-secrets ALPACA_API_KEY=ALPACA_API_KEY:latest \
            --set-secrets ALPACA_SECRET=ALPACA_SECRET:latest \
            --set-secrets SLACK_BOT_TOKEN=SLACK_BOT_TOKEN:latest \
            --max-retries 0 \
            --task-timeout 300s \
            --quiet

      # 6. UPDATE SCHEDULER (NEW STEP)
      - name: Update Cloud Scheduler
        run: |
          gcloud scheduler jobs update http darwinian-hourly \
            --schedule "${{ env.CRON_SCHEDULE }}" \
            --location ${{ secrets.GCP_REGION }} \
            --uri "https://${{ secrets.GCP_REGION }}-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/${{ secrets.GCP_PROJECT_ID }}/jobs/darwinian-swarm-job:run" \
            --oauth-service-account-email ${{ secrets.GCP_SA_EMAIL }} \
            --quiet
